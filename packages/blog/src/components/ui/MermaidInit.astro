---
// Mermaid diagram initialization component
// Conditionally loads mermaid.js only when diagrams are present on the page
---

<script>
  async function initMermaid() {
    const diagrams = document.querySelectorAll('pre.mermaid')
    if (diagrams.length === 0) return

    console.log('[mermaid] Found', diagrams.length, 'diagrams, loading mermaid.js...')

    const { default: mermaid } = await import('mermaid')

    // Detect current theme
    const htmlClass = document.documentElement.className
    let theme = 'default'
    if (htmlClass.includes('dark')) {
      theme = 'dark'
    }

    mermaid.initialize({
      startOnLoad: false,
      theme,
      gitGraph: {
        mainBranchName: 'main',
        showCommitLabel: true,
        showBranches: true,
        rotateCommitLabel: true
      }
    })

    // Use mermaid.run() to render all diagrams at once
    // This is the recommended API that handles DOM updates safely
    await mermaid.run({
      querySelector: 'pre.mermaid'
    })

    console.log('[mermaid] Diagrams rendered successfully')
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMermaid)
  } else {
    initMermaid()
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initMermaid)
</script>

<style is:global>
  pre.mermaid {
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
    text-align: center;
  }

  pre.mermaid[data-processed="true"] {
    overflow-x: auto;
  }

  pre.mermaid[data-processed="true"] svg {
    max-width: 100%;
    height: auto;
  }
</style>
