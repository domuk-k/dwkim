---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import MermaidInit from '@/components/ui/MermaidInit.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig } from '@/config'

const { title, description, pubDate, image, readingTime, toc } = Astro.props as PostLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).href
const imageUrl = image ? new URL(image, Astro.site).href : new URL(ogImage, Astro.site).href

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description || themeConfig.site.description,
  image: imageUrl,
  datePublished: pubDate.toISOString(),
  dateModified: pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: themeConfig.site.author,
    url: themeConfig.site.website
  },
  publisher: {
    '@type': 'Person',
    name: themeConfig.site.author
  },
  url: canonicalUrl,
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl
  }
}
---

<BaseLayout
  title={`${title} · ${themeConfig.site.title}`}
  description={description || themeConfig.site.description}
  type="post"
>
  <Fragment slot="head">
    <BaseHead
      title={`${title} · ${themeConfig.site.title}`}
      description={description || themeConfig.site.description}
      ogImage={ogImage}
    />
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </Fragment>
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        <div class="title">
          <h1>{title}</h1>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">·</span>
                  {readingTime.text}
                </span>
              )
            }
          </div>
        </div>
        <slot />
      </div>
    </main>
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <MermaidInit />
    {themeConfig.post.imageViewer && <ImageViewer />}
    {themeConfig.general.footer && <Footer />}
  </div>
</BaseLayout>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }
</style>
